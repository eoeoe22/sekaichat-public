<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>대화 - 미연시</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        body {
            display: flex;
            flex-direction: column;
            height: 100vh;
            overflow: hidden;
        }
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: var(--bg-color);
        }
        .chat-header {
            display: flex;
            align-items: center;
            padding: 1rem 1.25rem;
            background-color: var(--card-bg);
            border-bottom: 1px solid var(--border-color);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            flex-shrink: 0;
            gap: 1rem;
        }
        .back-btn {
            font-size: 1.5rem;
            color: var(--text-color);
            text-decoration: none;
        }
        .character-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        #characterAvatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
        }
        #characterName {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 0;
        }
        /* 수정: 호감도 표시 영역 너비 축소 + 왼쪽 현재 시간 아이콘 영역 추가 */
        .current-time-icon {
            font-size: 1.35rem;
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 34px;
            height: 34px;
            color: var(--button-color);
        }
        .affection-display {
            flex: 0 0 190px;
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        @media (max-width: 640px) {
            .affection-display {
                flex: 1 1 auto; /* 작은 화면에서는 다시 가변 */
            }
        }
        .affection-bar-wrapper {
            display: flex;
            align-items: center;
            gap: 0.45rem;
            font-size: 0.75rem;
        }
        .affection-bar-wrapper .bi { color: var(--button-color); }
        .affection-bar-wrapper .bi-heart-fill { color: #ff6b81; }
        .progress { height: 8px; border-radius: 4px; background-color: var(--border-color); }
        .progress-bar.bg-friendship { background-color: var(--button-color); }
        .progress-bar.bg-romantic { background-color: #ff6b81; }

        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            padding-bottom: 120px;
            transition: padding-bottom 0.2s;
        }
        .message { display: flex; gap: 0.75rem; margin-bottom: 1.25rem; max-width: 85%; }
        .message.user { flex-direction: row-reverse; margin-left: auto; }
        .message-avatar { width: 36px; height: 36px; border-radius: 50%; flex-shrink: 0; }
        .message-content { display: flex; flex-direction: column; }
        .message.user .message-content { align-items: flex-end; }
        .message-bubble { padding: 0.75rem 1rem; border-radius: 18px; line-height: 1.5; word-break: break-word; }
        .message.assistant .message-bubble { background-color: var(--card-bg); border: 1px solid var(--border-color); border-top-left-radius: 4px; }
        .message.user .message-bubble { background-color: var(--button-color); color: white; border-top-right-radius: 4px; }
        .message-meta { font-size: 0.75rem; color: var(--text-secondary); margin-top: 0.25rem; padding: 0 0.25rem; }

        .chat-input-area {
            position: fixed;
            left: 0;
            right: 0;
            bottom: 0;
            width: 100%;
            z-index: 100;
            padding: 1rem 1.25rem;
            border-top: 1px solid var(--border-color);
            background-color: var(--card-bg);
            flex-shrink: 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .chat-input-area .input-group {
            display: flex;
            align-items: flex-end;
            gap: 0.75rem;
        }
        #messageInput {
            flex-grow: 1;
            border-radius: 20px;
            resize: none;
            max-height: 120px;
            overflow-y: auto;
            padding: 0.6rem 1rem;
        }
        #sendButton {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            flex-shrink: 0;
        }
        
        .dropdown-menu {
             --bs-dropdown-bg: var(--card-bg);
             --bs-dropdown-border-color: var(--border-color);
             --bs-dropdown-link-color: var(--text-color);
             --bs-dropdown-link-hover-color: var(--text-color);
             --bs-dropdown-link-hover-bg: rgba(135, 206, 235, 0.2);
        }

        /* (추가) 수동 시간 버튼 그룹 스타일 */
        .time-options {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }
        .time-option-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            flex: 1 1 calc(50% - 0.5rem);
            font-size: 0.85rem;
            padding: 0.55rem 0.6rem;
            line-height: 1.2;
            /* --- 애니메이션 추가 --- */
            transition: background-color 0.3s, color 0.3s, transform 0.2s;
            position: relative;
            z-index: 1;
        }
        .time-option-btn:hover, .time-option-btn:focus {
            background-color: rgba(135, 206, 235, 0.18);
            color: var(--button-color);
            transform: translateY(-2px) scale(1.04);
            box-shadow: 0 4px 16px rgba(135,206,235,0.10);
        }
        .btn-check:checked + .time-option-btn {
            background-color: rgba(135, 206, 235, 0.27);
            color: var(--button-color);
            box-shadow: 0 8px 24px rgba(135,206,235,0.18);
            border-color: var(--button-color);
            transform: scale(1.06);
            /* --- 강조 애니메이션 --- */
            animation: timeBtnSelectPulse 0.55s;
        }
        @keyframes timeBtnSelectPulse {
            0%   { box-shadow: 0 0 0 rgba(135,206,235,0.0); transform: scale(1.0);}
            30%  { box-shadow: 0 0 10px 4px rgba(135,206,235,0.24); transform: scale(1.08);}
            60%  { box-shadow: 0 0 18px 8px rgba(135,206,235,0.12); transform: scale(1.03);}
            100% { box-shadow: 0 8px 24px rgba(135,206,235,0.18); transform: scale(1.06);}
        }
        .time-option-btn i {
            font-size: 1rem;
            transition: color 0.2s;
        }
        .btn-check:checked + .time-option-btn i {
            color: var(--button-color);
        }
        .time-option-btn small {
            font-size: 0.65rem;
        }
        @media (min-width: 560px) {
            .time-option-btn {
                flex: 1 1 calc(25% - 0.5rem);
            }
        }
        @media (max-width: 575.98px) {
            .chat-input-area {
                padding: 0.5rem 0.5rem;
            }
            .chat-messages {
                padding: 1rem 0.5rem;
                padding-bottom: 120px;
            }
            .current-time-icon {
                display: none;
            }
        }
        /* 시간설정 모달 자체의 fade-in 애니메이션 */
        #timeSettingsModal .modal-content {
            animation: fadeInModal 0.33s;
        }
        @keyframes fadeInModal {
            0% { opacity: 0; transform: translateY(18px) scale(0.97);}
            80% { opacity: 1; transform: translateY(0) scale(1.03);}
            100% { opacity: 1; transform: translateY(0) scale(1);}
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <!-- Chat Header -->
        <header class="chat-header">
            <a href="/dating" class="back-btn"><i class="bi bi-arrow-left"></i></a>
            <div class="character-info">
                <img id="characterAvatar" src="/images/characters/default.webp" alt="캐릭터 아바타">
                <h5 id="characterName">불러오는 중...</h5>
            </div>
            <!-- (추가) 현재 시간대 아이콘 -->
            <div id="currentTimeIcon" class="current-time-icon" title="현재 시간대"></div>
            <div class="affection-display">
                <div class="affection-bar-wrapper">
                    <i class="bi bi-people-fill" title="우정"></i>
                    <div class="progress flex-grow-1">
                        <div id="friendshipBar" class="progress-bar bg-friendship" role="progressbar" style="width: 50%;"></div>
                    </div>
                    <span id="friendshipValue">50</span>
                </div>
                <div class="affection-bar-wrapper">
                    <i class="bi bi-heart-fill" title="애정"></i>
                    <div class="progress flex-grow-1">
                        <div id="romanticBar" class="progress-bar bg-romantic" role="progressbar" style="width: 50%;"></div>
                    </div>
                    <span id="romanticValue">50</span>
                </div>
            </div>
            <div class="dropdown">
                <button class="btn btn-outline-secondary border-0" type="button" id="conversationMenuBtn" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-three-dots-vertical"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="conversationMenuBtn">
                    <li><a id="timeSettingsBtn" class="dropdown-item" href="#"><i class="bi bi-clock-fill me-2"></i> 시간 설정</a></li>
                    <li><a id="memoryCheckBtn" class="dropdown-item" href="#"><i class="bi bi-brain me-2"></i> 기억 확인</a></li>
                </ul>
            </div>
        </header>

        <!-- Messages Area -->
        <main id="messagesContainer" class="chat-messages">
            <!-- Messages will be injected here by JS -->
        </main>

        <!-- Input Area -->
        <footer class="chat-input-area">
            <div class="input-group">
                <textarea id="messageInput" class="form-control" placeholder="메시지 입력..." rows="1"></textarea>
                <button id="sendButton" class="btn btn-primary">
                    <i class="bi bi-send"></i>
                </button>
            </div>
        </footer>
    </div>
    
    <!-- Time Settings Modal -->
    <div class="modal fade" id="timeSettingsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="bi bi-clock-fill"></i> 시간 설정</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="timeSettingsForm">
                        <div class="mb-3">
                            <label class="form-label">시간 모드</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="time_mode" id="timeModeAuto" value="auto" checked>
                                <label class="form-check-label" for="timeModeAuto">자동 (현재 시간 기준)</label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="time_mode" id="timeModeManual" value="manual">
                                <label class="form-check-label" for="timeModeManual">수동</label>
                            </div>
                        </div>
                        <!-- (수정) 수동 시간대 선택: 라디오 목록 → 버튼 그룹 -->
                        <div id="manualTimeSelection" class="mb-3" style="display: none;">
                            <label class="form-label">시간대 선택</label>
                            <div class="time-options">
                                <input type="radio" class="btn-check" name="current_time" id="timeDawn" value="dawn">
                                <label class="btn btn-outline-secondary time-option-btn" for="timeDawn">
                                    <i class="bi bi-cloud-moon-fill"></i> 새벽
                                    <small class="text-muted d-block">(00:00 - 05:00)</small>
                                </label>
                                <input type="radio" class="btn-check" name="current_time" id="timeMorning" value="morning" checked>
                                <label class="btn btn-outline-secondary time-option-btn" for="timeMorning">
                                    <i class="bi bi-sunrise-fill"></i> 아침
                                    <small class="text-muted d-block">(05:00 - 12:00)</small>
                                </label>
                                <input type="radio" class="btn-check" name="current_time" id="timeDay" value="day">
                                <label class="btn btn-outline-secondary time-option-btn" for="timeDay">
                                    <i class="bi bi-sun-fill"></i> 낮
                                    <small class="text-muted d-block">(12:00 - 18:00)</small>
                                </label>
                                <input type="radio" class="btn-check" name="current_time" id="timeNight" value="night">
                                <label class="btn btn-outline-secondary time-option-btn" for="timeNight">
                                    <i class="bi bi-sunset-fill"></i> 밤
                                    <small class="text-muted d-block">(18:00 - 24:00)</small>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                    <button type="button" id="saveTimeSettingsBtn" class="btn btn-primary">저장</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Character Memory Modal -->
    <div class="modal fade" id="memoryCheckModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="memoryModalTitle"><i class="bi bi-brain"></i> 캐릭터의 기억</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p id="characterMemoryContent" class="text-muted">기억을 불러오는 중...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal">닫기</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/dating_chat.js"></script>
</body>
</html>
