<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>보컬로이드 가사 검색</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.13.1/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/landing.css">

    <style>
        :root {
            --bg-light: #ffffff;
            --bg-dark: #0f172a;
            --card-bg-light: #ffffff;
            --card-bg-dark: #1e293b;
            --text-color-light: #0f172a;
            --text-color-dark: #f8fafc;
            --border-color-light: #e2e8f0;
            --border-color-dark: #334155;
            --primary-color: #3b82f6;
            --character-badge-bg: #ffffff;
            --character-badge-border: #dee2e6;
            --character-badge-hover-bg: #f8f9fa;
            --character-img-border: #fff;
            --character-name-color: #495057;
        }

        @media (prefers-color-scheme: dark) {
            #searchInput.form-control {
                background-color: var(--card-bg);
                color: var(--text-color);
                border-color: var(--border-color);
            }

            .hero .input-group .btn {
                border-color: var(--border-color-light);
            }

            :root {
                --bg-color: var(--bg-dark);
                --text-color: var(--text-color-dark);
                --card-bg: var(--card-bg-dark);
                --border-color: var(--border-color-dark);
                --character-badge-bg: var(--bg-dark);
                --character-badge-border: var(--border-color-dark);
                --character-badge-hover-bg: var(--card-bg-dark);
                --character-img-border: var(--border-color-dark);
                --character-name-color: var(--text-color-dark);
            }

            body {
                background-color: var(--bg-color);
                color: var(--text-color);
            }

            .navbar {
                background: rgba(15, 23, 42, 0.85);
            }

            .card,
            .feature-card,
            .about-container {
                background-color: var(--card-bg);
                border-color: var(--border-color);
            }

            input.form-control {
                background-color: var(--card-bg);
                color: var(--text-color);
                border-color: var(--border-color);
            }

            input.form-control::placeholder {
                color: #94a3b8;
            }
        }

        .section {
            padding-top: 80px;
            padding-bottom: 60px;
        }

        .lyrics-section {
            display: none;
            text-align: left;
            white-space: pre-wrap;
        }

        .lyrics-section.show {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .character-badge {
            display: inline-flex;
            align-items: center;
            background-color: var(--character-badge-bg);
            border: 1px solid var(--character-badge-border);
            border-radius: 50px;
            padding: 4px 12px 4px 4px;
            margin-right: 8px;
            margin-bottom: 4px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
        }

        .character-badge:hover {
            transform: scale(1.05);
            background-color: var(--character-badge-hover-bg);
        }

        .character-img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 8px;
            border: 2px solid var(--character-img-border);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .character-name {
            font-weight: 600;
            font-size: 0.9rem;
            color: var(--character-name-color);
        }

        .hero {
            animation: fadeIn 0.5s ease-in-out;
        }

        .hero .input-group {
            align-items: stretch;
            animation: fadeIn 0.5s ease-in-out 0.3s;
            animation-fill-mode: both;
        }

        .hero .input-group .btn {
            margin: 0;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-top">
        <div class="container">
            <a class="navbar-brand fw-bold" href="/">
                <img src="/logo.jpg" alt="Logo" width="30" height="30"
                    class="d-inline-block align-text-top rounded-circle me-2">
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item"><a class="nav-link" href="/">홈으로</a></li>
                </ul>
            </div>
        </div>
    </nav>

    <header class="hero">
        <div class="container text-center">
            <h1 class="hero-title">보컬로이드 가사 검색</h1>
            <p class="hero-subtitle">좋아하는 보컬로이드 노래의 가사를 찾아보세요.</p>
            <div class="col-md-8 mx-auto">
                <div class="input-group">
                    <input type="text" id="searchInput" class="form-control form-control-lg" placeholder="검색어를 입력하세요"
                        onkeypress="handleKeyPress(event)">
                    <button class="btn btn-light btn-lg" type="button" onclick="performSearch()" id="searchBtn"><i
                            class="bi bi-search"></i></button>
                </div>
            </div>
        </div>
    </header>

    <main class="section">
        <div class="container">
            <div id="results" class="row g-4"></div>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <p></p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let characterData = [];

        async function performSearch() {
            const input = document.getElementById('searchInput');
            const btn = document.getElementById('searchBtn');
            const resultsDiv = document.getElementById('results');
            const query = input.value.trim();

            if (!query) return;

            btn.disabled = true;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            resultsDiv.innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-3 text-secondary">가사를 검색하고 있습니다...</p>
                </div>
            `;

            try {
                const response = await fetch('/api/vocaloid/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query })
                });

                if (!response.ok) {
                    throw new Error('Search failed');
                }

                const data = await response.json();
                characterData = data.characters || [];
                displayResults(data.matches);
            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger text-center" role="alert">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i> 검색 중 오류가 발생했습니다.
                        </div>
                    </div>
                `;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="bi bi-search"></i>';
            }
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                performSearch();
            }
        }

        function displayResults(matches) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '';

            if (!matches || matches.length === 0) {
                resultsDiv.innerHTML = `
                    <div class="col-12 text-center py-5 text-secondary">
                        <i class="bi bi-search" style="font-size: 3rem; opacity: 0.5;"></i>
                        <p class="mt-3">검색 결과가 없습니다.</p>
                    </div>
                `;
                return;
            }

            matches.forEach(match => {
                const cardCol = document.createElement('div');
                cardCol.className = 'col-lg-6';
                cardCol.innerHTML = createCard(match);
                resultsDiv.appendChild(cardCol);
            });

            // Attach event listeners to toggle buttons
            document.querySelectorAll('.toggle-lyrics-btn').forEach(btn => {
                btn.addEventListener('click', toggleLyrics);
            });
        }

        function toggleLyrics(event) {
            const btn = event.currentTarget;
            const card = btn.closest('.feature-card');
            const partialLyrics = card.querySelector('.partial-lyrics');
            const fullLyrics = card.querySelector('.full-lyrics');
            const span = btn.querySelector('span');
            const icon = btn.querySelector('i');

            const isExpanded = fullLyrics.style.display !== 'none';

            if (isExpanded) {
                // Collapse
                fullLyrics.style.display = 'none';
                partialLyrics.style.display = 'block';
                span.textContent = '전체 가사 보기';
                icon.classList.replace('bi-chevron-up', 'bi-chevron-down');
            } else {
                // Expand
                fullLyrics.style.display = 'block';
                partialLyrics.style.display = 'none';
                span.textContent = '가사 접기';
                icon.classList.replace('bi-chevron-down', 'bi-chevron-up');
            }
        }

        function createCard(match) {
            const singerHtml = formatSinger(match.singer);
            const titleText = match.title + (match.title_jp ? ` (${match.title_jp})` : '');

            // Prepare lyrics
            const fullLyrics = escapeHtml(match.lyrics || '');
            const lines = fullLyrics.split('\n');
            const partialLyrics = lines.slice(0, 5).join('\n') + (lines.length > 5 ? '\n...' : '');
            const hasMore = lines.length > 5;

            let lyricsHtml = `
                <div class="lyrics-container mb-3">
                    <div class="partial-lyrics" style="white-space: pre-wrap;">${partialLyrics}</div>
                    <div class="full-lyrics" style="display: none; white-space: pre-wrap;">${fullLyrics}</div>
                </div>
            `;

            let buttonHtml = '';
            if (hasMore) {
                buttonHtml = `
                    <button class="btn btn-outline-primary w-100 py-2 toggle-lyrics-btn">
                        <span class="me-2">전체 가사 보기</span>
                        <i class="bi bi-chevron-down transition-icon"></i>
                    </button>
                `;
            }

            return `
                <div class="feature-card h-100">
                    <div class="feature-icon"><i class="bi bi-music-note-list"></i></div>
                    <h3 class="mb-1">${escapeHtml(titleText)}</h3>
                    <a href="${escapeHtml(match.url)}" target="_blank" class="text-secondary mb-3 d-block">${escapeHtml(match.url)}</a>
                    <p class="text-secondary">작곡: ${escapeHtml(match.composer || '-')} / 작사: ${escapeHtml(match.lyricist || '-')}</p>
                    <div class="mb-3">
                        ${singerHtml}
                    </div>
                    ${lyricsHtml}
                    ${buttonHtml}
                </div>
            `;
        }

        function formatSinger(singerData) {
            if (singerData === undefined || singerData === null) return '-';

            // Ensure we have an array of strings to process
            let inputs = [];
            if (Array.isArray(singerData)) {
                inputs = singerData.map(String);
            } else {
                inputs = [String(singerData)];
            }

            // Prepare regex for known characters
            // Sort by length descending to match longest names first
            const sortedNames = characterData
                .map(c => c.name)
                .sort((a, b) => b.length - a.length);

            let pattern = null;
            if (sortedNames.length > 0) {
                // Escape regex special characters in names
                const escapedNames = sortedNames.map(n => n.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
                pattern = new RegExp(`(${escapedNames.join('|')})`, 'g');
            }

            let html = '';

            inputs.forEach(input => {
                if (!pattern) {
                    html += `<span class="me-2">${escapeHtml(input)}</span>`;
                    return;
                }

                // Split by the pattern. Capturing groups are included in the result.
                const parts = input.split(pattern);

                parts.forEach(part => {
                    if (!part) return;

                    // Check if this part is a known character
                    // We check against the original names (un-escaped)
                    const character = characterData.find(c => c.name === part);

                    if (character) {
                        html += `
                            <div class="character-badge">
                                <img src="${character.profile_image}" alt="${escapeHtml(character.name)}" class="character-img">
                                <span class="character-name">${escapeHtml(character.name)}</span>
                            </div>
                        `;
                    } else {
                        // Render as text
                        // We preserve spaces and separators
                        html += `<span class="me-1 align-middle">${escapeHtml(part)}</span>`;
                    }
                });
            });

            return html;
        }



        function escapeHtml(text) {
            if (!text) return '';
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>
</body>

</html>