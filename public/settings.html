<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>개인 설정 - 세카이 채팅</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.10.5/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="/css/style.css">
    <style>
        .settings-container { max-width: 960px; }
        .nav-pills .nav-link { color: var(--text-color); }
        .nav-pills .nav-link.active { background-color: var(--button-color); color: white; }
        .form-section {
            background: var(--card-bg);
            padding: 2rem;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 20px var(--shadow-color);
        }
        .error-message { color: #dc3545; }
    </style>
</head>
<body>
    <div class="container settings-container my-5">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="bi bi-gear-fill"></i> 개인 설정</h2>
            <a href="/playground" class="btn btn-secondary"><i class="bi bi-arrow-left"></i> 채팅으로 돌아가기</a>
        </div>

        <div class="row">
            <div class="col-md-3">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist" aria-orientation="vertical">
                    <button class="nav-link active" id="v-pills-profile-tab" data-bs-toggle="pill" data-bs-target="#v-pills-profile" type="button" role="tab"><i class="bi bi-person-fill"></i> 프로필</button>
                    <button class="nav-link" id="v-pills-account-tab" data-bs-toggle="pill" data-bs-target="#v-pills-account" type="button" role="tab"><i class="bi bi-key-fill"></i> 계정</button>
                    <button class="nav-link" id="v-pills-characters-tab" data-bs-toggle="pill" data-bs-target="#v-pills-characters" type="button" role="tab"><i class="bi bi-person-heart"></i> 내 캐릭터</button>
                    <button class="nav-link" id="v-pills-chat-tab" data-bs-toggle="pill" data-bs-target="#v-pills-chat" type="button" role="tab"><i class="bi bi-chat-dots-fill"></i> 채팅 설정</button>
                    <button class="nav-link" id="v-pills-sekai-tab" data-bs-toggle="pill" data-bs-target="#v-pills-sekai" type="button" role="tab"><i class="bi bi-globe"></i> 세계관 설정</button>
                    <button class="nav-link" id="v-pills-api-tab" data-bs-toggle="pill" data-bs-target="#v-pills-api" type="button" role="tab"><i class="bi bi-code-slash"></i> API 키</button>
                    <button class="nav-link" id="v-pills-migration-tab" data-bs-toggle="pill" data-bs-target="#v-pills-migration" type="button" role="tab"><i class="bi bi-database-down"></i> 데이터 이전</button>
                </div>
            </div>
            <div class="col-md-9">
                <div class="tab-content" id="v-pills-tabContent">
                    <!-- 프로필 설정 -->
                    <div class="tab-pane fade show active" id="v-pills-profile" role="tabpanel">
                        <div class="form-section">
                            <h5><i class="bi bi-person-badge"></i> 닉네임 변경</h5>
                            <form id="changeNicknameForm" class="mb-4">
                                <div class="mb-3">
                                    <label for="new_nickname" class="form-label">새 닉네임</label>
                                    <input type="text" name="new_nickname" id="new_nickname" class="form-control" placeholder="새 닉네임" required>
                                </div>
                                <button type="submit" class="btn btn-primary">변경하기</button>
                            </form>
                            <hr>
                            <h5><i class="bi bi-person-circle"></i> 프로필 이미지</h5>
                            <div class="mb-3">
                                <div class="d-flex align-items-center">
                                    <img id="profileImagePreview" src="/images/characters/default.webp" alt="프로필 이미지" class="rounded-circle me-3" style="width: 80px; height: 80px; object-fit: cover;">
                                    <div>
                                        <button class="btn btn-sm btn-primary" onclick="document.getElementById('profileImageInput').click();">이미지 선택</button>
                                        <input type="file" id="profileImageInput" accept="image/png,image/jpeg,image/webp" style="display: none;">
                                        <button id="deleteProfileImageBtn" class="btn btn-sm btn-danger ms-2">이미지 삭제</button>
                                    </div>
                                </div>
                                <div class="form-text mt-2">200x200 픽셀 PNG, JPG, WEBP, 최대 2MB</div>
                            </div>
                            <div class="form-check form-switch mb-4">
                                <input class="form-check-input" type="checkbox" role="switch" id="profileImageVisible" checked>
                                <label class="form-check-label" for="profileImageVisible">채팅에 프로필 이미지 표시</label>
                            </div>
                            <button id="saveProfileImageSettingsBtn" class="btn btn-primary">프로필 이미지 설정 저장</button>
                            <hr>
                            <h5><i class="bi bi-file-person"></i> 자기소개</h5>
                            <form id="selfIntroForm">
                                <div class="mb-3">
                                    <label for="selfIntroInput" class="form-label">자기소개</label>
                                    <textarea name="self_introduction" id="selfIntroInput" class="form-control" rows="3" placeholder="자기소개 예시: more more jump 매니저"></textarea>
                                </div>
                                <button type="submit" class="btn btn-primary">저장하기</button>
                            </form>
                        </div>
                    </div>
                    <!-- 계정 설정 -->
                    <div class="tab-pane fade" id="v-pills-account" role="tabpanel">
                        <div class="form-section">
                            <h5><i class="bi bi-shield-lock-fill"></i> 비밀번호 변경</h5>
                            <form id="changePasswordForm">
                                <div class="mb-3">
                                    <label for="current_password" class="form-label">현재 비밀번호</label>
                                    <input type="password" name="current_password" id="current_password" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label for="new_password" class="form-label">새 비밀번호</label>
                                    <input type="password" name="new_password" id="new_password" class="form-control" required>
                                </div>
                                <div class="mb-3">
                                    <label for="confirm_password" class="form-label">새 비밀번호 확인</label>
                                    <input type="password" name="confirm_password" id="confirm_password" class="form-control" required>
                                </div>
                                <button type="submit" class="btn btn-primary">변경하기</button>
                            </form>
                            <hr>
                            <h5><i class="bi bi-discord"></i> Discord 계정 연동</h5>
                            <div id="discordLinkSection">
                                <p>Discord 계정을 연동하여 간편하게 로그인할 수 있습니다.</p>
                                <a href="/auth/discord" class="btn btn-primary" style="background-color: #5865F2;">Discord 계정 연동하기</a>
                            </div>
                            <div id="discordInfoSection" style="display: none;">
                                <p>연동된 Discord 계정:</p>
                                <div class="d-flex align-items-center">
                                    <img id="discordAvatar" src="" alt="Discord Avatar" class="rounded-circle me-2" style="width: 40px; height: 40px;">
                                    <span id="discordUsername"></span>
                                </div>
                                <button id="unlinkDiscordBtn" class="btn btn-danger mt-3">연동 해제</button>
                            </div>
                        </div>
                    </div>
                    <!-- 내 캐릭터 -->
                    <div class="tab-pane fade" id="v-pills-characters" role="tabpanel">
                        <div class="form-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h5><i class="bi bi-person-heart"></i> 내 캐릭터 관리</h5>
                                <button id="createCharacterBtn" class="btn btn-primary"><i class="bi bi-plus-circle"></i> 새 캐릭터 만들기</button>
                            </div>
                            <div id="userCharactersList" class="user-characters-list"></div>
                        </div>
                    </div>
                    <!-- 채팅 설정 -->
                    <div class="tab-pane fade" id="v-pills-chat" role="tabpanel">
                        <div class="form-section">
                            <h5><i class="bi bi-arrow-repeat"></i> 자동 호출 설정</h5>
                            <div class="mb-3">
                                <label for="maxAutoCall" class="form-label">최대 연속 호출 횟수</label>
                                <input type="number" id="maxAutoCall" class="form-control" min="1" max="10" value="3">
                            </div>
                            <button type="button" class="btn btn-primary" id="saveAutoCallBtn">저장</button>
                        </div>
                    </div>
                    <!-- 세계관 설정 -->
                    <div class="tab-pane fade" id="v-pills-sekai" role="tabpanel">
                        <div class="form-section">
                            <h5><i class="bi bi-globe"></i> 세계관 필터링</h5>
                            <p>캐릭터 초대 목록에 표시할 세계관을 선택하세요.</p>
                            <div id="sekaiFilterContainer"></div>
                            <button id="saveSekaiSettingsBtn" class="btn btn-primary mt-3">설정 저장</button>
                        </div>
                    </div>
                    <!-- API 키 -->
                    <div class="tab-pane fade" id="v-pills-api" role="tabpanel">
                        <div class="form-section">
                            <h5><i class="bi bi-key-fill"></i> 개인 API 키 관리</h5>
                            <form id="apiKeyForm">
                                <div class="mb-3">
                                    <label for="apiKeyInput" class="form-label">개인 Gemini API 키</label>
                                    <input type="password" name="api_key" id="apiKeyInput" class="form-control masked-input" placeholder="개인 Gemini API 키">
                                </div>
                                <div>
                                    <button type="submit" id="apiKeySubmitBtn" class="btn btn-primary">등록하기</button>
                                    <button type="button" id="deleteApiKeyBtn" class="btn btn-danger" style="display:none;">삭제하기</button>
                                </div>
                            </form>
                        </div>
                    </div>
                    <!-- 데이터 이전 -->
                    <div class="tab-pane fade" id="v-pills-migration" role="tabpanel">
                        <div class="form-section">
                            <div id="migrationContainer">
                                <h5><i class="bi bi-database-down"></i> 대화내역 이전</h5>
                                <p>이전 버전의 카나데 챗봇 대화내역을 현재 계정으로 가져옵니다.</p>

                                <div id="kanadeLoginSection">
                                    <form id="kanadeLoginForm">
                                        <div class="mb-3">
                                            <label for="kanadeUsername" class="form-label">카나데 챗봇 아이디</label>
                                            <input type="text" class="form-control" id="kanadeUsername" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="kanadePassword" class="form-label">카나데 챗봇 비밀번호</label>
                                            <input type="password" class="form-control" id="kanadePassword" required>
                                        </div>
                                        <button type="submit" class="btn btn-primary w-100">카나데 계정으로 로그인</button>
                                    </form>
                                </div>

                                <div id="conversationSelectSection" style="display: none;">
                                    <h6>이전할 대화내역 선택</h6>
                                    <div class="d-flex flex-wrap">
                                        <div id="kanadeConversationList" class="list-group my-3" style="max-height: 300px; overflow-y: auto; flex: 1; min-width: 200px;"></div>
                                        <div id="conversationPreview" class="ms-md-3 p-3 border rounded" style="max-height: 300px; overflow-y: auto; flex: 2; display: none; min-width: 250px;"></div>
                                    </div>
                                    <button id="migrateBtn" class="btn btn-success w-100">선택한 대화내역 이전 시작</button>
                                </div>

                                <div id="migrationProgressSection" style="display: none;">
                                    <h6>이전 진행 중...</h6>
                                    <div class="progress my-3">
                                        <div id="migrationProgressBar" class="progress-bar" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">0%</div>
                                    </div>
                                    <p id="migrationStatus"></p>
                                </div>
                                
                                <div id="migrationResultSection" style="display: none;">
                                    <h6>이전 완료</h6>
                                    <p id="migrationResultMessage"></p>
                                    <button onclick="location.reload()" class="btn btn-primary w-100">완료</button>
                                </div>

                                <div id="errorMessage" class="error-message mt-3" style="display: none;"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 사용자 캐릭터 관련 모달 (chat.html에서 복사) -->
    <div class="modal fade" id="userCharacterModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg"><div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="userCharacterModalTitle"><i class="bi bi-person-plus"></i> 새 캐릭터 만들기</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="userCharacterForm">
                    <input type="hidden" id="editingCharacterId" value="">
                    <div class="form-group mb-3">
                        <label for="characterName" class="form-label">캐릭터 이름</label>
                        <input type="text" class="form-control" id="characterName" maxlength="50" required>
                        <div class="form-text">최대 50자</div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="characterImage" class="form-label">
                            프로필 이미지 
                            <span class="text-danger">*</span>
                            <small class="text-muted">(200×200px, PNG/JPG/WEBP, 최대 2MB)</small>
                        </label>
                        <div class="image-upload-container">
                            <input type="file" class="form-control" id="characterImage" accept="image/png,image/jpeg,image/webp" required>
                            <div id="imagePreview" class="image-preview mt-2" style="display:none;">
                                <img id="previewImg" src="" alt="미리보기" class="preview-image">
                                <div class="image-info" id="imageInfo"></div>
                            </div>
                        </div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="characterDescription" class="form-label">캐릭터 한 줄 소개</label>
                        <input type="text" class="form-control" id="characterDescription" maxlength="100" required placeholder="예: 미야마스자카 여학원의 활기찬 1학년">
                        <div class="form-text">최대 100자. 다른 캐릭터에게 이 캐릭터가 누구인지 설명합니다.</div>
                    </div>
                    <div class="form-group mb-3">
                        <label for="characterPrompt" class="form-label">
                            캐릭터 연기 프롬프트
                            <button type="button" class="work-mode-info-btn" data-bs-toggle="modal" data-bs-target="#characterCreationHelpModal" title="도움말">
                                <i class="bi bi-info-circle"></i>
                            </button>
                        </label>
                        <textarea class="form-control" id="characterPrompt" rows="8" maxlength="5000" required placeholder="캐릭터의 성격, 말투, 배경 등을 상세히 설명해주세요."></textarea>
                        <div class="form-text">최대 5000자. 캐릭터의 성격, 말투, 배경 등을 구체적으로 작성하면 더 자연스러운 대화가 가능합니다.</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">취소</button>
                <button type="button" class="btn btn-success" id="saveCharacterBtn">
                    <i class="bi bi-check-lg"></i> 저장
                </button>
            </div>
        </div></div>
    </div>
    <div class="modal fade" id="manageCharacterModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-gear-fill"></i> 캐릭터 관리</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="characterManageContent">
                    <div class="character-manage-info mb-3">
                        <img id="manageCharacterImage" src="" alt="캐릭터" class="character-manage-avatar">
                        <div class="character-manage-details">
                            <h6 id="manageCharacterName"></h6>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" id="editCharacterBtn">
                    <i class="bi bi-pencil"></i> 수정
                </button>
                <button type="button" class="btn btn-outline-danger" id="deleteCharacterBtn">
                    <i class="bi bi-trash"></i> 삭제
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">닫기</button>
            </div>
        </div></div>
    </div>
     <div class="modal fade" id="characterCreationHelpModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="bi bi-question-circle"></i> 캐릭터 생성 도움말</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="work-mode-explanation"> 
                    <h6><i class="bi bi-pencil-square"></i> 캐릭터 프롬프트 작성 가이드</h6>
                    <p>캐릭터의 성격, 말투, 배경 등을 자세하게 작성하면 AI가 캐릭터를 더 잘 연기할 수 있습니다.</p>
                    <br>
                    <p><a href="/characterinfo" target="_blank"><i class="bi bi-person-lines-fill"></i>캐릭터 프롬프트 예시</a></p>
                    <br>
                    <p>예시 캐릭터 프롬프트와 동일한 형식으로 작성하는것을 추천합니다.</p>
                    <hr>
                    <p><a href="https//aistudio.google.com" taget="_blank">구글 AI스튜디오</a>에서 Gemini 2.5 Pro 모델을 선택하고</p>
                    <br>
                    <p>Grounding With Google Search 옵션을 켠 다음</p>
                    <br>
                    <p>예시 프롬프트 하나를 복사해 붙여넣은 뒤, 이것과 동일한 형식으로 (캐릭터 이름)의 프롬프트를 작성해달라고 하면 편합니다.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">확인</button>
            </div>
        </div></div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/user-characters.js"></script>
    <script src="/js/settings.js"></script>
</body>
</html>
